<view class="container">
	<view class="map-area">
		<view class="map-controls">
			<picker mode="selector" range="{{maps}}" range-key="label" value="{{selectedMapIndex}}" bindchange="onMapChange">
				<view class="picker">楼层: {{maps[selectedMapIndex] && maps[selectedMapIndex].label || '加载中...'}}</view>
			</picker>
		</view>

		<canvas canvas-id="mapCanvas" class="map-canvas" bindtouchstart="onTouchStart" bindtouchmove="onTouchMove" bindtouchend="onTouchEnd" bindtap="onCanvasTap" style="width:100%;height:450px;"/>

		<cover-view class="legend">点击图标查看详情，支持双指捏合或右下角 +/- 缩放</cover-view>

		<cover-view class="zoom-knob">
			<cover-view class="zoom-label" wx:if="{{showZoomPercent}}">{{zoomPercent}}%</cover-view>
			<cover-view class="zoom-btn" bindtap="zoomIn">+</cover-view>
			<cover-view class="zoom-btn" bindtap="zoomOut">-</cover-view>
		</cover-view>
	</view>

	<!-- 导航控制按钮组 -->
	<view class="nav-btn-group">
		<view class="nav-row">
			<view class="nav-btn {{selectionMode === 'start' ? 'active' : ''}} {{selectionMode === 'end' ? 'disabled' : ''}}" bindtap="toggleSelectStart">
				{{selectionMode === 'start' ? '确认起点' : '选择起点'}}
			</view>
			<view class="nav-btn {{selectionMode === 'end' ? 'active' : ''}} {{selectionMode === 'start' ? 'disabled' : ''}}" bindtap="toggleSelectEnd">
				{{selectionMode === 'end' ? '确认终点' : '选择终点'}}
			</view>
		</view>
		<view class="nav-row">
			<view class="nav-btn reset-btn" bindtap="resetNav">重 置</view>
			<view class="nav-btn go-btn {{(!startPoint || !endPoint || selectionMode !== null) ? 'disabled' : ''}}" bindtap="doNavigation">导 航</view>
		</view>
	</view>

	<!-- 弹窗逻辑 -->
	<cover-view wx:if="{{showRegionModal}}" class="region-modal" catchtouchmove="noop" catchtap="noop">
		<cover-view class="modal-card" catchtouchmove="noop" catchtap="noop">
			<cover-view class="modal-close-x" bindtap="closeRegionModal">关闭</cover-view>
			<cover-view class="modal-body">
				<!-- 商铺优先展示（后端可能使用 store_name 字段或 type/store 类型标识） -->
				<cover-view wx:if="{{activeRegion && !activeRegion.is_facility && (activeRegion.store_name || activeRegion.type === 'store' || activeRegion.is_shop)}}">
						<cover-view class="info-card">
							<cover-view class="info-row">
								<cover-view class="info-label">商铺名</cover-view>
								<cover-view class="info-value">{{activeRegion.store_name || activeRegion.name}}</cover-view>
							</cover-view>
							<cover-view class="info-row" wx:if="{{activeRegion.phone || activeRegion.phone_number || activeRegion.contact_phone}}">
								<cover-view class="info-label">联系电话</cover-view>
								<cover-view class="info-value">{{activeRegion.phone || activeRegion.phone_number || activeRegion.contact_phone}}</cover-view>
							</cover-view>
							<cover-view class="info-row" wx:if="{{activeRegion.owner_name || activeRegion.organizer_name || activeRegion.contact_person}}">
								<cover-view class="info-label">负责人</cover-view>
								<cover-view class="info-value">{{activeRegion.owner_name || activeRegion.organizer_name || activeRegion.contact_person}}</cover-view>
							</cover-view>
							<cover-view class="info-row" wx:if="{{activeRegion.owner_phone || activeRegion.organizer_phone || activeRegion.contact_phone}}">
								<cover-view class="info-label">联系方式</cover-view>
								<cover-view class="info-value">{{activeRegion.owner_phone || activeRegion.organizer_phone || activeRegion.contact_phone}}</cover-view>
							</cover-view>
							<cover-view class="info-row" wx:if="{{activeRegion.open_time || activeRegion.open || activeRegion.business_hours || activeRegion.close_time}}">
								<cover-view class="info-label">营业时间</cover-view>
								<cover-view class="info-value">{{activeRegion.open_time || activeRegion.open || (activeRegion.business_hours ? activeRegion.business_hours : '—')}}{{activeRegion.close_time ? ' - ' + activeRegion.close_time : ''}}</cover-view>
							</cover-view>
							<cover-view class="info-row info-row-multi">
								<cover-view class="info-label">详情</cover-view>
								<cover-view class="info-value info-value-multi">{{activeRegion.description || activeRegion.desc || activeRegion.detail || activeRegion.summary || '无'}}</cover-view>
							</cover-view>
						</cover-view>
					<!-- 图片已移除：无需显示 -->
				</cover-view>
				<!-- 活动区域：仅显示 类型、负责人、联系电话、详情 -->
				<cover-view wx:elif="{{activeRegion && (activeRegion.is_event || activeRegion.area_type === 'eventarea' || activeRegion.type === 'event' || (activeRegion._raw && (activeRegion._raw.is_event || activeRegion._raw.__kind === 'eventarea')))}}">
						<cover-view class="info-card">
							<cover-view class="info-row">
								<cover-view class="info-label">类型</cover-view>
								<cover-view class="info-value">{{activeRegion.type_display || '活动区域'}}</cover-view>
							</cover-view>
							<cover-view class="info-row" wx:if="{{activeRegion.organizer_name}}">
								<cover-view class="info-label">负责人</cover-view>
								<cover-view class="info-value">{{activeRegion.organizer_name}}</cover-view>
							</cover-view>
							<cover-view class="info-row" wx:if="{{activeRegion.organizer_phone}}">
								<cover-view class="info-label">联系电话</cover-view>
								<cover-view class="info-value">{{activeRegion.organizer_phone}}</cover-view>
							</cover-view>
							<cover-view class="info-row info-row-multi">
								<cover-view class="info-label">详情</cover-view>
								<cover-view class="info-value info-value-multi">{{activeRegion.description || '-'}}</cover-view>
							</cover-view>
						</cover-view>
				</cover-view>
				<!-- 设施（point）只显示一行类型 -->
				<cover-view wx:elif="{{activeRegion && activeRegion.is_facility && !activeRegion.is_shop}}">
						<cover-view class="info-card">
							<cover-view class="info-pill">设施类型：{{activeRegion.type_display || activeRegion.facility_type || activeRegion.type || activeRegion.area_type}}</cover-view>
						</cover-view>
				</cover-view>
				<!-- 其他区域：仅显示 类型、是否为公共区域、详情 -->
				<cover-view wx:elif="{{activeRegion}}">
						<cover-view class="info-card">
							<cover-view class="info-row">
								<cover-view class="info-label">类型</cover-view>
								<cover-view class="info-value">{{activeRegion.type_display || activeRegion.area_type || activeRegion.type || '-'}}</cover-view>
							</cover-view>
							<cover-view class="info-row">
								<cover-view class="info-label">公共区域</cover-view>
								<cover-view class="info-value">{{(activeRegion.is_public || (activeRegion._raw && activeRegion._raw.is_public)) ? '是' : '否'}}</cover-view>
							</cover-view>
							<cover-view class="info-row info-row-multi">
								<cover-view class="info-label">详情</cover-view>
								<cover-view class="info-value info-value-multi">{{activeRegion.description || '-'}}</cover-view>
							</cover-view>
						</cover-view>
				</cover-view>
			</cover-view>
		</cover-view>
	</cover-view>
</view>