<!-- 搜索：区域 & 活动 -->
<view class="search-page">
	<view class="search-header">
		<view class="search-bar">
			<!-- 左侧下拉菜单 -->
			<picker bindchange="bindTypeChange" value="{{typeIndex}}" range="{{searchTypes}}">
				<view class="type-selector">
					<text>{{searchTypes[typeIndex]}}</text>
					<view class="arrow-down"></view>
				</view>
			</picker>		
			<!-- 垂直分割线 -->
			<view class="search-divider"></view>
			<!-- 输入框 -->
			<input 
				class="search-input" 
				placeholder="{{placeholderList[typeIndex]}}" 
				placeholder-class="placeholder"
				value="{{keyword}}" 
				bindinput="onInput"
				confirm-type="search"
				bindconfirm="doSearch"
			/>
			<!-- 搜索按钮 -->
			<view class="search-btn" bindtap="doSearch">搜索</view>
		</view>
	</view>

	<!-- 搜索结果区域 -->
  	<view class="results-container">
		<!-- 店铺搜索结果 -->
		<view class="section results-section" wx:if="{{storeResults.length > 0}}">
			<view class="category-tag">店 铺</view>
			<view 
				class="result-card" 
				wx:for="{{storeResults}}" 
				wx:key="id" 
				bindtap="openStore" 
				data-id="{{item.id}}"
			>
				<view class="act-title">{{item.store_name}}</view>
				<view class="act-meta">营业时间：{{item.open_time}} 至 {{item.close_time}}</view>
			</view>
		</view>
		<!-- 活动搜索结果 -->
		<view class="section results-section" wx:if="{{eventResults.length > 0}}">
			<view class="category-tag">活 动</view>
			<view 
				class="result-card" 
				wx:for="{{eventResults}}" 
				wx:key="id" 
				bindtap="openEvent" 
				data-id="{{item.id}}"
			>
				<view class="act-title">{{item.event_name}}</view>
				<view class="act-meta">活动时间：{{item.start_date}} 至 {{item.end_date}}</view>
			</view>
		</view>
		<!-- 只有当点击过搜索，且两个数组都为空时，才显示 -->
		<view class="empty" wx:if="{{hasSearched && storeResults.length === 0 && eventResults.length === 0}}">
			未找到相关内容
		</view>
  	</view>

	<!-- 详情弹窗 -->
	<view class="modal-mask" wx:if="{{showModal}}" bindtap="closeModal" catchtouchmove="true">
		<view class="modal-content" catchtap="none">
			<view class="modal-header">
				<text class="modal-title">{{modalType === 'store' ? '店铺详情' : '活动详情'}}</text>
				<view class="close-icon" bindtap="closeModal">关闭</view>
			</view>
			
			<scroll-view scroll-y class="modal-body">
				<view wx:if="{{modalLoading}}" class="modal-loading">加载中...</view>
				
				<block wx:else>
					<!-- 店铺详情视图 -->
					<view wx:if="{{modalType === 'store'}}">
						<!-- 左侧图片，右侧名称与种类 -->
						<view class="store-main-header">
							<!-- 店铺图片：设置 mode="aspectFill" 确保正方形裁剪填充 -->
							<image 
								class="store-main-image" 
								src="{{modalDetail.image_url || '/images/default-store.png'}}" 
								mode="aspectFill"
							/>
							<view class="store-header-text">
								<view class="store-name-large">{{modalDetail.store_name}}</view>
								<view class="store-tags">
									<view class="store-type-tag">
										{{storeTypeMap[modalDetail.type] != null ? storeTypeMap[modalDetail.type] : '其他'}}
									</view>
									<view class="status-tag {{modalDetail.isOpen ? 'is-open' : 'is-closed'}}">
										{{modalDetail.statusLabel}}
									</view>
								</view>
							</view>
						</view>
						<!-- 分割线 -->
						<view class="modal-divider"></view>
						<!-- 其他详细信息列表 -->
						<view class="detail-row">
							<text class="label">营业时间：</text>
							<text class="value">{{modalDetail.open_time}} - {{modalDetail.close_time}}</text>
						</view>
						<view class="detail-row">
							<text class="label">租户姓名：</text>
							<text class="value">{{modalDetail.owner_name}}</text>
						</view>
						<view class="detail-row">
							<text class="label">租户电话：</text>
							<text class="value">{{modalDetail.owner_phone}}</text>
						</view>
						<view class="detail-row">
							<text class="label">店铺简介：</text>
							<text class="value">{{modalDetail.description || '暂无简介'}}</text>
						</view>
						<view class="detail-row" wx:if="{{modalDetail.api_url}}">
							<text class="label">店铺链接：</text>
							<view 
								class="value url-link" 
								bindtap="handleLinkTap" 
								data-url="{{modalDetail.api_url}}"
							>
								点击复制并访问
							</view>
						</view>
						<!-- 分割线 -->
						<view class="modal-divider"></view>
						<!-- 在地图中查看的按钮-->
						<view 
							class="map-location-btn" 
							bindtap="openInMap"
							data-shape="{{modalDetail.shape}}" 
							data-type="storearea"
							data-areaid="{{modalDetail.id}}"
							wx:if="{{modalDetail.shape}}"
						>
							<text >在地图中查看</text>
						</view>
						<!-- 关联活动列表 -->
						<view class="sub-section" wx:if="{{modalRelatedEvents.length > 0}}">
							<view class="sub-title">关联活动列表</view>
							<view class="mini-card" wx:for="{{modalRelatedEvents}}" wx:key="id">
								<view class="detail-row">
									<view class="event-name-large">{{item.event_name}}</view>
								</view>
								<view class="detail-row">
									<view class="event-type-tag">
										<!-- 严格照抄：activities/index.wxml的处理方法 area_type_label -->
										{{item.area_type_label || '其他'}}
									</view>
									<view class="status-tag {{item.is_active ? 'is-open' : 'is-closed'}}">
										{{item.is_active ? '可参与' : '已暂停'}}
									</view>
								</view>
								<view class="detail-row">
									<text class="value">{{item.description || '暂无简介'}}</text>
								</view>
								<view class="detail-row">
									<text class="label">活动周期：</text>
									<text class="value">{{item.start_date}} 开始\n{{item.end_date}} 结束</text>
								</view>
							</view>
						</view>
					</view>

					<!-- 活动详情视图 -->
					<view wx:if="{{modalType === 'event'}}">
						<!-- 左侧图片，右侧名称与种类 -->
						<view class="event-main-header">
							<!-- 活动图片：设置 mode="aspectFill" 确保正方形裁剪填充 -->
							<image 
								class="event-main-image" 
								src="{{modalDetail.image_url || '/images/default-event.png'}}" 
								mode="aspectFill"
							/>
							<view class="event-header-text">
								<view class="event-name-large">{{modalDetail.event_name}}</view>
								<view class="event-tags">
									<view class="event-type-tag">
										<!-- 严格照抄：activities/index.wxml的处理方法 area_type_label -->
										{{modalDetail.area_type_label || '其他'}}
									</view>
									<view class="status-tag {{modalDetail.is_active ? 'is-open' : 'is-closed'}}">
										{{modalDetail.is_active ? '可参与' : '已暂停'}}
									</view>
								</view>
							</view>
						</view>
						<!-- 分割线 -->
						<view class="modal-divider"></view>
						<!-- 其他详细信息列表 -->
						<view class="detail-row">
							<text class="label">活动简介：</text>
							<text class="value">{{modalDetail.description || '暂无简介'}}</text>
						</view>
						<view class="detail-row">
							<text class="label">活动周期：</text>
							<text class="value">{{modalDetail.start_date}} 开始\n{{modalDetail.end_date}} 结束</text>
						</view>
						<!-- 关联区域列表 -->
						<view class="sub-section" wx:if="{{modalRelatedStoreareas.length > 0 || modalRelatedEventareas.length > 0}}">
							<view class="sub-title">关联区域列表</view>
							<!-- 循环显示店铺区域 -->
							<view class="mini-card" wx:for="{{modalRelatedStoreareas}}" wx:key="id">
								<view class="detail-row">
									<view class="store-name-large">{{item.store_name}}</view>
								</view>
								<view class="detail-row">
									<text class="value">{{item.description || '暂无简介'}}</text>
								</view>
								<view class="detail-row">
									<text class="label">店主：</text>
									<text class="value">{{item.owner_name}}</text>
								</view>
								<view class="detail-row">
									<text class="label">联系方式：</text>
									<text class="value">{{item.owner_phone}}</text>
								</view>
								<view class="detail-row">
									<text class="label">营业时间：</text>
									<text class="value">{{item.open_time}} - {{item.close_time}}</text>
								</view>
								<!-- 在地图中查看的按钮-->
								<view 
									class="map-location-btn" 
									bindtap="openInMap"
									data-shape="{{item.shape}}" 
									data-type="storearea"
									data-areaid="{{item.id}}"
									wx:if="{{item.shape}}"
								>
									<text >在地图中查看</text>
								</view>
							</view>
							<!-- 循环显示活动区域 -->
							<view class="mini-card" wx:for="{{modalRelatedEventareas}}" wx:key="id">
								<view class="detail-row">
									<view class="eventarea-name-large">活动区域</view>
								</view>
								<view class="detail-row">
									<view class="value">{{item.description || '-'}}</view>
								</view>
								<view class="detail-row">
									<text class="label">负责人：</text>
									<text class="value">{{item.organizer_name}}</text>
								</view>
								<view class="detail-row">
									<text class="label">联系方式：</text>
									<text class="value">{{item.organizer_phone}}</text>
								</view>
								<!-- 在地图中查看的按钮-->
								<view 
									class="map-location-btn" 
									bindtap="openInMap" 
									data-shape="{{item.shape}}"
									data-type="eventarea"
									data-areaid="{{item.id}}"
									wx:if="{{item.shape}}"
								>
									<text >在地图中查看</text>
								</view>
							</view>
						</view>
					</view>
				</block>
			</scroll-view>

		</view>
	</view>
</view>